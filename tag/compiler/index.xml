<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Compiler | å¾æ—­æ ‹</title><link>/tag/compiler/</link><atom:link href="/tag/compiler/index.xml" rel="self" type="application/rss+xml"/><description>Compiler</description><generator>Wowchemy (https://wowchemy.com)</generator><language>zh-Hans</language><copyright>Copyright Â© 2014 - 2021 Xudong Xu. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</copyright><lastBuildDate>Sat, 26 Nov 2016 18:00:05 +0000</lastBuildDate><image><url>/media/icon_hua2ec155b4296a9c9791d015323e16eb5_11927_512x512_fill_lanczos_center_2.png</url><title>Compiler</title><link>/tag/compiler/</link></image><item><title>å†è°ˆ Swift Performance</title><link>/2016/11/26/%E5%86%8D%E8%B0%88-swift-performance/</link><pubDate>Sat, 26 Nov 2016 18:00:05 +0000</pubDate><guid>/2016/11/26/%E5%86%8D%E8%B0%88-swift-performance/</guid><description>&lt;p>éšç€ WWDC 2016 çš„ç¦»å»ï¼ŒWWDC 2017 ä¹Ÿå·²æ‚„ç„¶ç«Ÿæ¥è¿‘ï¼Œæ˜å¹´è‹¹æœå°†é‡å›åŠ å·åœ£ä½•å¡ &lt;code>McEnery&lt;/code> ä¸¾åŠå¼€å‘è€…å¤§ä¼šï¼Œè¿™ä¸ªæ—¶å€™é‚£äº›è¯¥å±•æœ›çš„ã€è¿˜æ²¡å±•æœ›çš„ï¼Œä¹ŸåŸºæœ¬è¢«è®¨è®ºçš„å·®ä¸å¤šäº†ï¼Œè™½ç„¶åœ¨è¿™ä¸ªæ—¶é—´ç‚¹æ¥è®¨è®º Swift Performance è™½ç„¶æœ‰äº›è€ç”Ÿå¸¸è°ˆï¼Œä½†ä¹Ÿä¸å¤±ä¸ºä¸€ä¸ªå¥½çš„è¯é¢˜ã€‚&lt;/p>
&lt;h2 id="class-ä¸-struct-çš„å–èˆ">&lt;code>class&lt;/code> ä¸ &lt;code>struct&lt;/code> çš„å–èˆ&lt;/h2>
&lt;p>ä»€ä¹ˆæƒ…å†µä¸‹è¯¥ç”¨å“ªç§ &lt;code>first class type&lt;/code> æ¥å»ºç«‹æˆ‘ä»¬çš„ &lt;code>Model&lt;/code>ï¼Œè™½ç„¶å„è·¯è‹±æ‰å¿ƒé‡Œè‡ªæœ‰å›¾è°±ï¼Œä½†è¿˜æ˜¯å¾ˆæœ‰å¿…è¦æ‹‰å‡ºæ¥è®¨è®ºä¸€ä¸‹ã€‚åˆ°åº•æ˜¯ç”¨ &lt;code>class&lt;/code> è¿˜æ˜¯ &lt;code>struct&lt;/code>ã€ç”¨ &lt;code>value&lt;/code> è¿˜æ˜¯ &lt;code>reference&lt;/code> ï¼Œå…³é”®çš„çº¦æŸç‚¹åœ¨äºæ€§èƒ½å¼€é”€ä¸å¤šæ€çš„å®ç°æ–¹å¼ã€‚&lt;/p>
&lt;h3 id="å†…å­˜åˆ†é…">å†…å­˜åˆ†é…&lt;/h3>
&lt;p>äººå°½çš†çŸ¥ &lt;code>heap&lt;/code> æ¯” &lt;code>stack&lt;/code> æ›´æ˜‚è´µï¼Œ&lt;code>heap&lt;/code> ç‰ºç‰²äº†æ€§èƒ½ä»¥æ¢å–æ¯” &lt;code>stack&lt;/code> æ›´è‡ªç”±çš„å†…å­˜ç®¡ç†ï¼Œ&lt;code>stack&lt;/code> ç‰ºç‰²äº†å¤æ‚çš„æ•°æ®ç»“æ„æ¥è·å–å’Œ &lt;code>Int&lt;/code> èµ‹å€¼ä¸€æ ·å¿«çš„ allocationã€‚&lt;/p>
&lt;p>&lt;code>heap&lt;/code> ä¹‹æ‰€ä»¥æ˜‚è´µã€æ€§èƒ½å¼€é”€å¤§ï¼Œæ˜¯å› ä¸ºå¼€è¾Ÿå†…å­˜æ—¶éœ€è¦è€ƒè™‘åˆ°å¤šçº¿ç¨‹ç”³è¯·åŒä¸€å—å†…å­˜ &lt;code>block&lt;/code> è€Œäº§ç”Ÿçš„ç«äº‰é—®é¢˜ï¼Œå› æ­¤é¦–å…ˆéœ€è¦åŠ é”æ¥è¾¾åˆ° Thread Safetyï¼Œç„¶åï¼Œéœ€è¦å»æ‰¾åˆ°æœªè¢«ä½¿ç”¨ä½¿ç”¨çš„å†…å­˜å¹¶ç”³è¯·åˆå§‹åŒ–ï¼Œç”¨å®Œäº†ä¹‹åè¿˜å¾—è¿˜å›å»å°†å…¶ deallocateï¼Œè€Œæˆ‘ä»¬èƒ½å¾—åˆ°çš„å¥½å¤„åˆ™æ˜¯æ›´åŠ åŠ¨æ€çš„å†…å­˜ç”Ÿå‘½å‘¨æœŸã€‚å¹¶ä¸”ä¸åƒ C++ï¼ŒSwift åªèƒ½åœ¨å †ä¸Šåˆå§‹åŒ– &lt;code>class&lt;/code>ï¼Œå¯¹äº &lt;code>class&lt;/code> é€‰å‹çš„å–èˆæ˜¾å¾—å°¤å…¶é‡è¦ã€‚&lt;/p>
&lt;p>åè§‚ &lt;code>stack&lt;/code>ï¼Œä¹‹æ‰€ä»¥å…¶æ€§èƒ½å¥½æ˜¯å› ä¸ºå…¶å¼€è¾Ÿå†…å­˜ä»…ä»…ä¾èµ–äº &lt;code>ESP&lt;/code> çš„ä¸Šä¸‹ç§»åŠ¨ï¼Œä»¥å…¸å‹è‡ªåº•å‘ä¸Šçš„æ ˆç»“æ„ä¸ºä¾‹ï¼Œä¸€æ¬¡å‡½æ•°è°ƒç”¨æ‰€éœ€è¦çš„ stack allocate ä»…ä»…éœ€è¦ä¸Šç§» &lt;code>ESP&lt;/code>ï¼Œè€Œå½“å‡½æ•°ä½“ç»“æŸæ—¶å†æŠŠ &lt;code>ESP&lt;/code> æŒ‡å›å…¥æ ˆä¹‹å‰çš„ä½ç½®ï¼Œä¸Šæ®µå†…å­˜è‡ªç„¶å°± deallocate äº†ã€‚æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ &lt;code>stack&lt;/code>ï¼Œä¸è¦è€ƒè™‘å¤šçº¿ç¨‹åŠ é”ï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘ä¸‹ä¸€å—å†…å­˜æ˜¯å¦å¯ç”¨ã€‚ä½†é™åˆ¶åœ¨äºï¼Œå½“æ‰§è¡Œä¸€æ¬¡å®Œæ•´çš„ &lt;code>call stack&lt;/code>ï¼Œ&lt;code>EBP&lt;/code> çš„ä½ç½®æ˜¯å›ºå®šçš„ï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨å†…å­˜å°±è¿™ç‚¹ï¼Œæ‰€ä»¥åœ¨æ ˆä¸Šèƒ½åšçš„äº‹å°±è¢«å¤§å¤§çš„é™åˆ¶ï¼Œå¦åˆ™å°±ç­‰ç€ Overflowã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">struct Car {
var serial: Int
}
let car = Car(serial: 123456)
// Fake car, have a fake serial, which is equal to car.serial
let fakeCar = aCar
// do sth with car, fakeCar
&lt;/code>&lt;/pre>
&lt;p>è¿™æ ·ä¸€æ®µä»£ç åœ¨ &lt;code>stack&lt;/code> ä¸Šä»…ä»…ç”¨äº† 2 ä¸ªå­—çš„å¤§å°ï¼Œç”¨äºå­˜å‚¨ä¸¤ä¸ª &lt;code>car&lt;/code> çš„ &lt;code>serial&lt;/code>ã€‚å°±è½»é‡çº§ï¼Œå¼€é”€ä½è¿™äº›ç‰¹ç‚¹æ¥è¯´ï¼Œåœ¨å·¥ç¨‹ä¸­ç”¨ &lt;code>struct&lt;/code> æ¥å»ºæ¨¡çœ‹ä¸Šå»æ˜¯æŒºç¾æ»‹æ»‹çš„ï¼Œä½†æŠ›å¼€å¤šæ€å•å°±æ€§èƒ½æ¥è¯´ï¼Œæ˜¯å¦æ„å‘³ç€ &lt;code>struct&lt;/code> æ€»æ˜¯èƒ½æˆä¸º &lt;code>Modeling&lt;/code> çš„é¦–é€‰ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå½“ &lt;code>struct&lt;/code> é‡è§ &lt;code>ARC&lt;/code> æ—¶ï¼Œå¥¹å°±å˜å¾—å¹¶ä¸é‚£ä¹ˆè½»é‡çº§äº†ã€‚&lt;/p>
&lt;h3 id="arc">&lt;code>ARC&lt;/code>&lt;/h3>
&lt;p>Swift å¯¹äº &lt;code>heap&lt;/code> ä¸Šå®ä¾‹çš„å†…å­˜ç®¡ç†ï¼Œé‡‡ç”¨çš„æœºåˆ¶ä¾æ—§æ˜¯ &lt;code>ARC&lt;/code>ã€‚&lt;/p>
&lt;p>ARC çš„åœ¨æ€§èƒ½ä¸Šçš„å¼€é”€ä¸»è¦æ˜¯åœ¨ &lt;code>swift_retain&lt;/code> &amp;amp; &lt;code>swift_release&lt;/code> æ‰€äº§ç”Ÿçš„å¤šæ¬¡ &lt;code>indirection&lt;/code> ä»¥åŠå¤šçº¿ç¨‹çš„åŠ é”ä¿æŠ¤ã€‚å¯¹äº &lt;code>trivial&lt;/code> çš„ &lt;code>struct&lt;/code> æ¥è¯´å› ä¸ºä¸æ¶‰åŠ &lt;code>ARC&lt;/code>ï¼Œå› æ­¤æ²¡æœ‰å½±å“ã€‚ä½†å½“ &lt;code>struct&lt;/code> æœ¬èº«å¦‚æœåŒ…å«äº†éœ€è¦ &lt;code>ARC&lt;/code> çš„å®ä¾‹æ—¶ï¼Œä»–å°±å˜å¾—ä¸é‚£ä¹ˆé«˜æ•ˆäº†ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">struct Car {
var name: String
var model: String
}
let newCar = Car(name: &amp;quot;Tesla&amp;quot;, model: &amp;quot;Model S&amp;quot;)
let myCar = newCar
print(myCar.name)
&lt;/code>&lt;/pre>
&lt;p>å°± &lt;code>Car&lt;/code> æ¥è¯´ï¼Œ&lt;code>name&lt;/code> å’Œ &lt;code>model&lt;/code> è™½ç„¶æ˜¯ &lt;code>String&lt;/code>ï¼Œ æ˜¯ä¸€ä¸ª &lt;code>struct&lt;/code>ï¼Œä½†æ˜¯ &lt;code>String&lt;/code> çš„ &lt;code>underlying buffer storage&lt;/code> æ˜¯å¼€è¾Ÿåœ¨å †ä¸Šçš„ï¼Œéœ€è¦å’Œ &lt;code>Class&lt;/code> ä¸€æ ·çš„ä½œ &lt;code>retain count&lt;/code>ï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿå¦‚ä¸‹æ‰€ç¤ºä»£ç ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">struct Car {
var name: String
var model: String
}
let newCar = Car(name: &amp;quot;Tesla&amp;quot;, model: &amp;quot;Model S&amp;quot;)
let myCar = newCar
print(myCar.name)
swift_retain(myCar.name._storage)
swift_retain(myCar.model._storage)
swift_release(myCar.name._storage)
swift_release(myCar.model._storage)
swift_release(newCar.name._storage)
swift_release(newCar.model._storage)
&lt;/code>&lt;/pre>
&lt;p>è¿‡å¤šçš„ &lt;code>retain&lt;/code> &amp;amp; &lt;code>release&lt;/code> å¸¦æ¥æ€§èƒ½å¼€é”€æ˜¯æˆ‘ä»¬ä¸æƒ³çœ‹åˆ°çš„ï¼Œè€Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨ &lt;code>class&lt;/code> æ¥å®ç°åˆ™å±•å¼€æˆå¦‚ä¸‹å½¢å¼ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">class Car {
var name: String
var model: String
init(name: String, model: String) {
self.name = name
self.model = model
}
}
let newCar = Car(name: &amp;quot;Tesla&amp;quot;, model: &amp;quot;Model S&amp;quot;)
let myCar = newCar
swift_retain(myCar)
print(myCar.name)
swift_retain(myCar)
// ... do sth
swift_release(myCar)
swift_release(newCar)
&lt;/code>&lt;/pre>
&lt;p>åœ¨å®é™…çš„è¿‡ç¨‹ä¸­ï¼Œ&lt;code>Model&lt;/code> æ˜¾ç„¶ä¸ä¼šè¿™ä¹ˆç®€å•ï¼Œä¸€ä¸ªå¯¹è±¡ä¸Šæœ‰ 10 å‡  20 ä¸ªéœ€è¦çš„ &lt;code>ARC&lt;/code> çš„ &lt;code>property&lt;/code> ä¹Ÿä¸æ˜¯ä¸å¯èƒ½çš„ï¼Œè¿™æ—¶å€™è°¨æ…ä½¿ç”¨ &lt;code>struct&lt;/code> æ˜¯æˆ‘ä»¬éœ€è¦æ³¨æ„çš„é›·åŒºã€‚&lt;/p>
&lt;p>ä¸€ä¸ªå¥½çš„å®è·µæ˜¯å¤šç”¨ &lt;code>built-in&lt;/code> çš„ &lt;code>type&lt;/code> å’Œç»“æ„æ¥æ„å»ºæ¨¡å‹ï¼Œæ¯”å¦‚ &lt;code>Car.model&lt;/code>ï¼Œä½œä¸ºä¸€ä¸ª &lt;code>String&lt;/code>ï¼Œå®ƒå…¶å®æ²¡æœ‰å¾ˆå¥½çš„çº¦æŸ &lt;code>Car.model&lt;/code> æ‰€æƒ³è¡¨è¾¾çš„å†…å®¹ï¼Œå®ƒå¯ä»¥æ˜¯ä»»ä½•å­—ç¬¦ä¸²ä¾‹å¦‚ &lt;code>Car.model = &amp;quot;foo&amp;quot;&lt;/code>ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å·®çš„è®¾è®¡ã€‚å› æ­¤å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ &lt;code>enum&lt;/code> æ¥å¯¹ &lt;code>model&lt;/code> åšçº¦æŸã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">extension Car {
enum Model {
case s
case x
}
}
struct Car {
var name: String
var model: Car.Model
}
&lt;/code>&lt;/pre>
&lt;p>è™½ç„¶æ˜¯ä¸€ä¸ªå¾ˆå°çš„ä¼˜åŒ–ç‚¹ï¼Œä½†ç»“æœå³æé«˜äº†è¯­ä¹‰çš„æ¸…æ™°åº¦ï¼Œåˆå‡å°‘äº†ä¸å¿…è¦çš„å¼€é”€ï¼Œå¯è°“ä¸€çŸ³åŒé¸Ÿã€‚&lt;/p>
&lt;h2 id="å¤šæ€">å¤šæ€&lt;/h2>
&lt;p>&lt;code>Dyanmic Dispatch&lt;/code> ä½œä¸ºç±»å¤šæ€å®ç°çš„åŸºç¡€ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯è®¨è®ºäº†æ¯”è¾ƒå¤šçš„è¯é¢˜ï¼Œå¯¹äº &lt;code>class&lt;/code> æ¥è¯´ï¼Œç¼–è¯‘å™¨ä¼šç»™å…¶æ·»åŠ é¢å¤–çš„ &lt;code>field&lt;/code> æ¥å‚¨å­˜ &lt;code>Type&lt;/code> çš„ä¿¡æ¯ï¼Œ&lt;code>runtime&lt;/code> é€šè¿‡ &lt;code>Type&lt;/code> çš„ &lt;code>v-table&lt;/code> æ¥æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œå…·ä½“å…³äº &lt;code>Dynamic Dispatch&lt;/code> çš„è®¨è®ºå¯è§ä¹‹å‰çš„ &lt;a href="../whole-module-optimizations/">Whole Module Optimization åˆ†æ&lt;/a>ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚&lt;/p>
&lt;p>å›åˆ° &lt;code>struct&lt;/code>ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨ &lt;code>struct&lt;/code> ä¸Šå®ç°å¤šæ€ï¼Œé‚£å°±å¾—ä¾é  &lt;code>protocol&lt;/code> æ¥å®ç°ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">protocol Turboable {
func turbo()
}
func turbo(_ stuffs: [Turboable]) {
stuffs.forEach {
$0.turbo()
}
}
struct Car {
var name: String
}
extension Car: Turboable {
func turbo() {
print(&amp;quot;turbo Car&amp;quot;)
}
}
struct Jet {
var name: String
}
extension Jet: Turboable {
func turbo() {
print(&amp;quot;turbo Jet&amp;quot;)
}
}
struct Tractor {
var name: String
var serail: Int
}
extension Tractor: Turboable {
func turbo() {
print(&amp;quot;turbo Tractor&amp;quot;)
}
}
let myStuffs: [Turboable] = [
Jet(name: &amp;quot;MiG-25&amp;quot;),
Car(name: &amp;quot;Chevrolet&amp;quot;),
Tractor(name: &amp;quot;Mercedes-Benz&amp;quot;,serial: 1)
]
turbo(myStuffs)
&lt;/code>&lt;/pre>
&lt;p>è¿™æ˜¯ä¸€æ®µå¾ˆå¸¸è§çš„ &lt;code>Protocol Oriented Programming&lt;/code>ï¼Œå®é™…ä¸Šè¿™å¹¶ä¸æ˜¯æ²¡æœ‰é¢å¤–æ€§èƒ½å¼€é”€çš„ã€‚å’Œ &lt;code>Class&lt;/code> ä¸ä¸€æ ·ï¼Œé€šè¿‡ &lt;code>protocol&lt;/code> å®ç°çš„å¤šæ€æ˜¯é€šè¿‡ &lt;code>Protocol Witness Table&lt;/code> æ¥åš &lt;code>Dispatch&lt;/code>ï¼Œæ¯ä¸€ä¸ªå®ç°äº† &lt;code>Turboable&lt;/code> çš„ç±»å‹ï¼Œç¼–è¯‘å™¨éƒ½ä¼šç”Ÿæˆä¸€ä»½ &lt;code>PWT&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">struct JetPWT {
func turbo(_ jet: Jet) {
jet.turbo()
}
}
struct CarPWT {
func turbo(_ car: Car) {
car.turbo()
}
}
struct TractorPWT {
func turbo(_ tractor: Tractor) {
tractor.turbo()
}
}
&lt;/code>&lt;/pre>
&lt;p>åŒæ—¶å¯¹äº &lt;code>Array&lt;/code>ï¼Œåº•å±‚çš„ &lt;code>buffer&lt;/code> æ˜¾ç„¶æ›´å–œæ¬¢ä»¥å›ºå®šçš„å¤§å°å»è¿ç»­çš„å­˜å‚¨å…ƒç´ ï¼Œè€Œä¸åŒçš„ &lt;code>type&lt;/code> å´æœ‰ç€ä¸åŒçš„å†…å­˜å¸ƒå±€ï¼Œå› æ­¤ Swift ä½¿ç”¨äº† &lt;code>Existential Containner&lt;/code> å»å­˜å‚¨å…ƒç´ ï¼Œè¿™æ ·ä¸€ä¸ªå®¹å™¨æä¾›äº†ä¸ªä¸‰ä¸ªå­—å¤§å°çš„ &lt;code>value Buffer&lt;/code> ç”¨äºå­˜å‚¨å…ƒç´ ã€‚&lt;/p>
&lt;p>ä½†å¦‚æœå…ƒç´ çš„å†…å­˜å¸ƒå±€è¿‡å¤§å¯¼è‡´ &lt;code>value Buffer&lt;/code> æ”¾ä¸ä¸‹ï¼Œä¾‹å¦‚ä¸‰ä¸ªå­—å¯¹äº &lt;code>struct Jet&lt;/code> è¶³å¤Ÿå¤§ï¼Œä½†å¯¹äº &lt;code>struct Tractor&lt;/code>ï¼Œå› ä¸º &lt;code>String&lt;/code>.&lt;code>size&lt;/code> + &lt;code>Int&lt;/code>.&lt;code>size&lt;/code> &amp;gt; 3 ä½¿å¾—å®ƒæ— æ³•å­˜æ”¾åœ¨åªæœ‰ä¸‰ä¸ªå­—å¤§å°çš„ &lt;code>buffer&lt;/code> ä¸­ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">// 24 bytes, 3 word
let jetSize = MemoryLayout&amp;lt;Jet&amp;gt;.size
// 32 bytes, 4 words
let tractorSize = MemoryLayout&amp;lt;Tractor&amp;gt;.size
&lt;/code>&lt;/pre>
&lt;p>å› æ­¤ &lt;code>Existential Containner&lt;/code> ä¼šåœ¨å †ä¸Šå¼€è¾Ÿç©ºé—´ç”¨æ¥æ‹·è´å­˜å‚¨ä¸€ä»½ &lt;code>Tractor&lt;/code>ï¼ŒåŒæ—¶å°†æŒ‡é’ˆå­˜æ”¾åœ¨ &lt;code>value Buffer&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>æ‰€ä»¥è°ƒç”¨ &lt;code>func turbo(_ stuffs: [Turboable])&lt;/code> å®é™…ä¸Šç»å¤§éƒ¨åˆ†çš„æ€§èƒ½å¼€é”€éƒ½èŠ±è´¹åœ¨å¯¹ç»“æ„ä½“è¿›è¡Œå†…å­˜åˆ†é…ä¸Šã€‚&lt;/p>
&lt;p>åŒæ—¶ï¼Œè°ˆåŠäº†å†…å­˜æ“ä½œï¼Œä¸åŒçš„ &lt;code>type&lt;/code> å¯¹åº”çš„å†…å­˜å¸ƒå±€æ˜¯ä¸åŒçš„ï¼Œ&lt;code>Existential Containner&lt;/code> éœ€è¦é¢å¤–ä¿¡æ¯æ‰èƒ½ä¸ºè¿™äº› &lt;code>type&lt;/code> åšå †å†…å­˜åˆå§‹åŒ–ã€æ‹·è´ã€é‡Šæ”¾ï¼Œå› æ­¤ Swift å¼•å…¥äº† &lt;code>Value Witness Table&lt;/code> æ¥ç®¡ç† &lt;code>value type&lt;/code> åœ¨å †ä¸Šçš„ç”Ÿå‘½å‘¨æœŸã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">struct JetVWT {
// åœ¨å †ä¸Šåˆå§‹åŒ–ä¸€å—ç”¨äºå­˜æ”¾ Jet çš„å†…å­˜ï¼Œå¹¶æŠŠåœ°å€èµ‹ç»™ Existential Containner
func allocate()
// æŠŠ stack Jet çš„å†…å­˜ copy åˆ° heap ä¸Š
func copy()
// ç”¨äº class type å¼•ç”¨è®¡æ•°é€’å‡
func destruct()
// é‡Šæ”¾å †å†…å­˜
func deallocate()
}
struct CarVWT {
...
}
struct TractorVWT {
...
}
&lt;/code>&lt;/pre>
&lt;p>å› æ­¤ &lt;code>Existential Containner&lt;/code> è¿˜éœ€è¦é¢å¤–çš„ä¸¤ä¸ªå­—çš„ç©ºé—´ç”¨æ¥å­˜æ”¾ &lt;code>PWT&lt;/code> å’Œ &lt;code>VWT&lt;/code> çš„åœ°å€ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">struct ExistContTurboable {
var valueBuffer: (Int, Int, Int)
var vwt: ValueWitnessTable
var pwt: TurboableProtocolWitnessTable
}
&lt;/code>&lt;/pre>
&lt;p>é€šå¸¸æ¥è¯´ &lt;code>Existential Containner&lt;/code> çš„å¤§å°æ˜¯ 5 ä¸ªå­—ã€‚&lt;/p>
&lt;pre>&lt;code>// 40 bytes, 5 words
let turboableSize = MemoryLayout&amp;lt;Turboable&amp;gt;.size
&lt;/code>&lt;/pre>
&lt;p>è™½ç„¶å®˜æ–¹æ²¡å£°æ˜ï¼Œä½†æ˜¯å¤šä¸ª &lt;code>protocol&lt;/code> çš„æƒ…å†µä¸‹ä¸€ä»½ &lt;code>pwt&lt;/code> åº”è¯¥æ˜¯ä¸å¤Ÿçš„ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">// 48 bytes, 6 words
let turboableSize = MemoryLayout&amp;lt;Turboable &amp;amp; CustomReflectable&amp;gt;.size
&lt;/code>&lt;/pre>
&lt;p>æ‰€ä»¥å¤šä¸ª &lt;code>protocol&lt;/code> çš„ç»“æ„ä¼šæ˜¯å¦‚ä¸‹æ‰€ç¤ºçš„å¸ƒå±€ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">struct ExistContTurboableCustomReflectable {
var valueBuffer: (Int, Int, Int)
var vwt: ValueWitnessTable
var pwt: (TurboableProtocolWitnessTable, CustomReflectableWitnessTable)
}
&lt;/code>&lt;/pre>
&lt;p>ä»¥ä¸Šæ•´ä¸ªæµç¨‹å®ç°äº† &lt;code>protocol&lt;/code> çš„ &lt;code>Dynamic Dispatch&lt;/code>ï¼Œé‚£ä¹ˆæœ€ç»ˆ &lt;code>func turbo(_ stuffs: [Turboable])&lt;/code> ä¼šç”Ÿæˆä¸‹æ–‡æ‰€ç¤ºçš„ä¼ªä»£ç ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">
func turbo(val: [ExistContTurboable]) {
val.forEach { element in
// on the heap
var local = ExistContTurboable()
let vwt = element.vwt
let pwt = element.pwt
local.vwt = vwt
local.pwt = pwt
// æ‹·è´ local var è‡³ valueBuffer æˆ–è€…å †ä¸Šçš„å†…å­˜
vwt.allocateBufferAndCopyValue(&amp;amp;local, element)
// è·å–åˆ° valueBuffer æˆ–è€…å †ä¸Šçš„å®ä¾‹
pwt.turbo(vwt.projectBuffer(&amp;amp;local))
// æ¸…ç†ç°åœº
vwt.destructAndDeallocateBuffer()
}
}
&lt;/code>&lt;/pre>
&lt;p>ç›¸æ¯”äº &lt;code>class&lt;/code>ï¼Œé€šè¿‡ &lt;code>protocol&lt;/code> å®ç°çš„ &lt;code>Dynamic Dispatch&lt;/code> æ‰€å¸¦æ¥çš„æ€§èƒ½ä¸‹é™æ ¹æ®æ•°æ®å¤§å°çš„ä¸åŒå¯èƒ½é«˜è¾¾æ•°å€ï¼Œå¹¶ä¸”ä¸ä»…ä»…æ˜¯ &lt;code>protocol type&lt;/code>ï¼Œä¹ŸåŒ…æ‹¬äº† &lt;code>stdlib&lt;/code> ä¸­çš„ä¸€äº›å‡½æ•°ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">public func max&amp;lt;T&amp;gt;(_ x: T, _ y: T) -&amp;gt; T where T : Comparable
&lt;/code>&lt;/pre>
&lt;p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå…¸å‹çš„èŒƒå‹å‡½æ•°ï¼Œç¼–è¯‘å™¨åœ¨ä¼˜åŒ– Scope è¢«é™åˆ¶çš„æ¡ä»¶ä¸‹ï¼Œä¼šä¿å®ˆçš„ç”Ÿæˆç¬¦åˆæ‰€æœ‰ case çš„å‡½æ•°ã€‚&lt;/p>
&lt;pre>&lt;code class="language-swift">public func max&amp;lt;T&amp;gt;(_ x: T, _ y: T, _ pwt: TypePWT, _ vwt: TypeVWT) -&amp;gt; T where T : Comparable
&lt;/code>&lt;/pre>
&lt;p>åŒæ ·ç”¨åˆ°äº† &lt;code>PWT&lt;/code> å’Œ &lt;code>VWT&lt;/code>ï¼Œå‡½æ•°ä½“çš„å†…éƒ¨ä¹ŸåŒæ ·ç”¨ &lt;code>valueBuffer&lt;/code> æ¥å­˜å‚¨æ•°æ®ï¼Œä¸€æ ·æ˜¯ 3 ä¸ªå­—çš„å¤§å°ï¼ˆè‹¹æœä¼°è®¡å’Œ G èƒ–æœ‰ä»‡ï¼‰ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯æ²¡ç”¨ &lt;code>Existential Container&lt;/code> åˆ°ï¼Œå› ä¸ºè¿™ä¸ªå¯¹äºæ¯æ¬¡è°ƒç”¨åªæœ‰ä¸€ç§ &lt;code>type&lt;/code> çš„å‚æ•°æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚&lt;/p>
&lt;p>å½“ç„¶è¿™ç§é€šè¿‡èŒƒå‹å®ç°çš„ &lt;code>Static Polymorphism&lt;/code> ä»ç„¶æ˜¯ &lt;code>Dynamic Dispathc&lt;/code> è™½ç„¶å¯¹æ€§èƒ½å¼€é”€æœ‰å½±å“ï¼Œä½†æ˜¯é€šè¿‡ &lt;code>Generic Specialization&lt;/code> å¯ä»¥ä½¿å…¶è¾¾åˆ° &lt;code>Static Dispathc&lt;/code>ï¼ŒåŒæ ·ä¹‹å‰çš„ &lt;a href="../whole-module-optimizations/">Whole Module Optimization åˆ†æ&lt;/a> æœ‰æåŠï¼Œæ‰€ä»¥ä¸å†èµ˜è¿°ã€‚&lt;/p>
&lt;div class="alert alert-note">
&lt;div>
2017-07-14 Updated
&lt;/div>
&lt;/div>
&lt;p>åœ¨ WWDC 2017 ä¸Šï¼Œè‹¹æœç»ˆäºå‡ºæ‰‹è¿™ä¸ªè§£å†³ &lt;code>valueBuffer&lt;/code> çš„æ€§èƒ½é—®é¢˜äº†ï¼Œ&lt;code>Unpredictable Performance Cliff&lt;/code>ã€‚è‹¹æœçš„æ–¹æ¡ˆæ˜¯é‡‡ç”¨ &lt;code>COW Existential Buffers&lt;/code>ï¼Œç®€å•æ¥è¯´å°±æ˜¯å¤ªå¤§æ²¡æ³•æ”¾è¿› &lt;code>valueBuffer&lt;/code> çš„ valueï¼Œè‹¹æœå¯¹å…¶é‡‡ç”¨å’Œç±»ä¸€æ ·çš„ &lt;code>reference counting&lt;/code>ï¼Œå¤šä¸ª &lt;code>Existential Container&lt;/code> å¯ä»¥å…±äº«ç›¸åŒçš„ &lt;code>buffer&lt;/code> ç›´åˆ°è¿™ä¸ª value éœ€è¦è¢«ä¿®æ”¹æ‰ä¼šè¢«é‡æ–°åˆ†é…å†…å­˜ï¼Œä»¥å‡å°‘ &lt;code>heap allocation&lt;/code> çš„æ¬¡æ•°ï¼Œå…¸å‹çš„ COW æœºåˆ¶ã€‚&lt;/p>
&lt;p>åŒæ ·å¯¹äºèŒƒå‹çš„ &lt;code>valueBuffer&lt;/code>ï¼ŒåŸæ¥çš„ &lt;code>heap allocation&lt;/code> è¢«æ›¿æ¢ä¸º &lt;code>stack allocation&lt;/code>ï¼Œè§„é¿äº†å †å†…å­˜ç®¡ç†ï¼Œè¿™ä¸‹å¯ä»¥æ›´åŠ è‚†æ— å¿Œæƒ®çš„ä½¿ç”¨èŒƒå‹å’Œ &lt;code>protocol&lt;/code> äº†ã€‚&lt;/p>
&lt;h2 id="ç»“è¯­">ç»“è¯­&lt;/h2>
&lt;p>æˆ‘ä»¬æ•°æ®å»ºæ¨¡çš„æ–¹å¼å°æ”¹åŠ¨ä¼šå¯¹æ€§èƒ½é€ æˆå·¨å¤§çš„å½±å“ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬è®¾è®¡æ¯ä¸€ä¸ªä»£ç ç¯èŠ‚æ—¶ï¼Œæˆ‘ä»¬éƒ½æœ‰è¿™æ ·æ€ç»´ï¼Œè¿™æ®µä»£ç å‘ç”Ÿäº†ä»€ä¹ˆã€ä¼šäº§ç”Ÿæ€ä¹ˆæ ·çš„æ€§èƒ½å¼€é”€ã€å†…å­˜æ˜¯å¦‚ä½•åˆ†é…çš„ã€‚&lt;/p>
&lt;p>åœ¨å·¥ç¨‹ä¸­éƒ½åº”è¯¥æ ¹æ®å®é™…åœºæ™¯ä»”ç»†æ–Ÿé…Œé‡‡å–å“ªç§æœºåˆ¶æ¥è·å–ä¼˜é›…çš„å®ç°ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šå¯¹æ€§èƒ½åšä¼˜åŒ–ï¼Œæ˜¯éœ€è¦ &lt;code>class&lt;/code> çš„ OOP ç‰¹æ€§ï¼Œè¿˜æ˜¯ &lt;code>struct&lt;/code> çš„ value ç‰¹æ€§ï¼Œæ˜¯éœ€è¦ &lt;code>protocol&lt;/code> çš„æ›´åŠ çµæ´»çš„ &lt;code>Dynamic Polymorphism&lt;/code>ï¼Œè¿˜æ˜¯ç”±èŒƒå‹å¸¦æ¥çš„æ›´åŠ  &lt;code>static&lt;/code> çš„ &lt;code>Static Polymorphism&lt;/code>ã€‚&lt;/p>
&lt;p>æ€»ä¹‹è¿˜æ˜¯é‚£å¥è¯ï¼Œå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼Œäº†è§£ä½ çš„ç¼–è¯‘å™¨ï¼Œè¿™æ ·æ‰èƒ½è®©ç¼–è¯‘å™¨æ›´å¥½çš„ç†è§£ä½ ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒæ–‡çŒ®">å‚è€ƒæ–‡çŒ®&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://developer.apple.com/videos/play/wwdc2016/416/" target="_blank" rel="noopener">Understanding Swift Performance&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.apple.com/videos/play/wwdc2017/402/" target="_blank" rel="noopener">What&amp;rsquo;s New in Swift 4&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://academy.realm.io/posts/goto-mike-ash-exploring-swift-memory-layout/" target="_blank" rel="noopener">Exploring Swift Memory Layout&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://academy.realm.io/posts/real-world-swift-performance/" target="_blank" rel="noopener">Real World Swift Performance&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Whole-Module Optimization åˆ†æ</title><link>/2016/07/14/whole-module-optimization-%E5%88%86%E6%9E%90/</link><pubDate>Thu, 14 Jul 2016 18:00:05 +0000</pubDate><guid>/2016/07/14/whole-module-optimization-%E5%88%86%E6%9E%90/</guid><description>&lt;p>Swift è‡ªè¯ç”Ÿä»¥æ¥ï¼Œå°±æ ‡æ¦œäº† &lt;strong>Performance&lt;/strong>ã€‚WWDC 2015 ä¸Šè‹¹æœä¸º Swift 2 å¼•å…¥çš„ Swift Compiler ç‰¹æ€§ &lt;code>Whole-Module Optimization&lt;/code> å°†å…¶å†ä¸€æ¬¡æ‹‰ä¸Šäº† &lt;strong>Performance&lt;/strong> çš„èˆå°ï¼Œé‚£ä¹ˆ &lt;code>WMO&lt;/code> åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;p>é€šå¸¸æ¥è¯´ï¼ŒSwift æ–‡ä»¶æ˜¯å•ç‹¬ç¼–è¯‘çš„ï¼Œè¿™æ ·çš„ç¼–è¯‘æ¨¡å¼ä¸ä½†å¯ä»¥å……åˆ†å‘æŒ¥å¤šæ ¸å¿ƒçš„ä¼˜åŠ¿åšåˆ°å¹¶è¡Œç¼–è¯‘è€Œä¸”è¿˜èƒ½åšåˆ°å•æ–‡ä»¶ç»´åº¦çš„å¢é‡ç¼–è¯‘ã€‚&lt;/p>
&lt;pre>&lt;code class="language-mermaid">stateDiagram-v2
File1.swift --&amp;gt; Compiler
Compiler --&amp;gt; File1.o
File2.swift --&amp;gt; Compiler
Compiler --&amp;gt; File2.o
File3.swift --&amp;gt; Compiler
Compiler --&amp;gt; File3.o
&lt;/code>&lt;/pre>
&lt;p>è¿™å¾ˆåˆæƒ…ä¹Ÿå’Œå¾ˆåˆç†ï¼Œç”¨ Apple çš„è¯æ¥è¯´å°±æ˜¯&lt;/p>
&lt;blockquote>
&lt;p>That&amp;rsquo;s &lt;strong>good&lt;/strong> ğŸ˜€&lt;/p>
&lt;/blockquote>
&lt;p>ç„¶è€Œè¿™æ ·ä¼šæŠŠ Optimizer èƒ½è·å–åˆ°çš„ä¸Šä¸‹æ–‡å±€é™åœ¨å•ä¸ªæ–‡ä»¶å†…ï¼Œé‚£ä¹ˆæ˜¾è€Œæ˜“è§çš„é—®é¢˜æ˜¯ï¼Œæ•´ä¸ªæ¨¡å—å†…çš„æ­»å‡½æ•°ã€&lt;code>Dynamic Dispatch&lt;/code> çš„ &lt;code>V-Table&lt;/code> æŸ¥è¯¢ã€æ³›å‹ç‰¹ä¾‹åŒ–ç­‰ç­‰éƒ½æ— æ³•è¢«å¾ˆå¥½çš„ä¼˜åŒ–ï¼Œæ‰€ä»¥ç²¾ç›Šæ±‚ç²¾çš„ Apple è®¤ä¸ºï¼Œè¿™è¿˜æ˜¯ä¸å¤Ÿ &lt;strong>good&lt;/strong>ï¼Œå› æ­¤å¼•å…¥äº† &lt;code>Whole-Moudle Optimization&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code class="language-mermaid">stateDiagram-v2
File1.swift --&amp;gt; Compiler
File2.swift --&amp;gt; Compiler
File3.swift --&amp;gt; Compiler
Compiler --&amp;gt; File.o
&lt;/code>&lt;/pre>
&lt;p>&lt;code>WMO&lt;/code> å°†æ•´ä¸ªæ¨¡å—çš„å†…çš„ Swift æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªï¼ŒæŠŠé¢—ç²’åº¦æå‡åˆ°æ•´ä¸ªæ¨¡å—ï¼Œè¿™æ ·å¯ä»¥åšåˆ°åœ¨ Build Source é˜¶æ®µï¼ŒOptimizer åªè¿›è¡Œä¸€æ¬¡æ¨¡å—çº§åˆ«çš„ä¼˜åŒ–ï¼Œç”¨ Apple çš„è¯æ¥è¯´å°±æ˜¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Analyze everything at once, aggressive optimization, very &lt;strong>good&lt;/strong> ğŸ˜€&lt;/p>
&lt;/blockquote>
&lt;p>&lt;code>WMO&lt;/code> å¯¹äº Swift æ‰€èƒ½å¸¦æ¥çš„æå‡å®˜æ–¹ç§°æœ‰ 2x ~ 5xï¼Œå¦‚æ­¤ &lt;strong>good&lt;/strong> çš„æ€§èƒ½æå‡ä½¿å¾—ä» Xcode 8 å¼€å§‹ WMO å°±æˆä¸ºäº†é»˜è®¤æ ‡é…ï¼Œæ‰€ä»¥ &lt;code>WMO&lt;/code> å¿«åœ¨å“ªï¼Ÿ&lt;/p>
&lt;h3 id="æ³›å‹ç‰¹ä¾‹åŒ–">æ³›å‹ç‰¹ä¾‹åŒ–&lt;/h3>
&lt;p>ä»¥ &lt;a href="https://github.com/apple/swift/blob/master/stdlib/public/core/Algorithm.swift" target="_blank" rel="noopener">stdlib&lt;/a> ä¸­çš„å‡½æ•°ä¸ºä¾‹ã€‚&lt;/p>
&lt;pre>&lt;code>// File1.swift
@_inlineable
public func max&amp;lt;T : Comparable&amp;gt;(_ x: T, _ y: T) -&amp;gt; T {
// In case `x == y`, we pick `y`. See min(_:_:).
return y &amp;gt;= x ? y : x
}
&lt;/code>&lt;/pre>
&lt;p>ç”±äºæ˜¯æ³›å‹ï¼Œç¼–è¯‘å™¨æ— ä»çŸ¥é“ &lt;code>type T&lt;/code> å…·ä½“ç±»å‹æ˜¯ &lt;code>Int&lt;/code>ã€&lt;code>Double&lt;/code> è¿˜æ˜¯å…¶å®ƒä»»ä½• &lt;code>Comparable&lt;/code> çš„ç±»å‹ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šå»å‡½æ•°è¡¨é‡Œæ‰¾ç±»å‹åŒ¹é…å‡½æ•°ï¼Œ åŒæ—¶ç¼–è¯‘å™¨ä¹Ÿæ— ä»çŸ¥é“ &lt;code>type T&lt;/code> æ˜¯å¦éœ€è¦ä¸ºå…¶ &lt;code>reference counting&lt;/code>(e.g &lt;code>class Foo: Comparable&lt;/code>)ï¼Œæ‰€ä»¥ä¸ºäº†åº”ä»˜æ‰€æœ‰å¯èƒ½çš„ &lt;code>type T&lt;/code> æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šä¿å®ˆçš„ç”Ÿæˆå¦‚ä¸‹ä¼ªä»£ç ã€‚&lt;/p>
&lt;pre>&lt;code>// File1.swift
@_inlineable
func max&amp;lt;T : Comparable&amp;gt;(x: T, y: T, FTable: FunctionTable) -&amp;gt; T {
let xCopy = FTable.copy(x)
let yCopy = FTable.copy(y)
let ret = !FTable.lessThan(yCopy, xCopy) ? y : x
FTable.release(x)
FTable.release(y)
return ret
}
&lt;/code>&lt;/pre>
&lt;p>ç„¶è€Œåœ¨ &lt;code>runtime&lt;/code> æ—¶æœŸï¼Œå¯¹äºè¯¸å¦‚ Int è¿™ç±»çš„åŸºæœ¬ç±»å‹æ¥è¯´ï¼Œç¼–è¯‘å™¨æ’å…¥çš„ &lt;code>copy()&lt;/code>ã€&lt;code>release()&lt;/code> æ˜¯æ¯«æ— æ„ä¹‰å´åˆæ˜¯ç¡®å®å­˜åœ¨çš„ï¼Œæ‰€ä»¥å’Œ &lt;code>Template Specialization&lt;/code> ç±»ä¼¼ï¼ŒSwift Compiler å¼•å…¥äº† &lt;code>Generic Specialization&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code>// File1.swift
func foo() {
let x: Int = ...
let y: Int = ...
let ret = max(x, y)
...
}
&lt;/code>&lt;/pre>
&lt;p>åœ¨è¿™æ ·ä¸€ä¸ªä¸Šä¸‹æ–‡å†…ï¼Œ&lt;code>Compiler&lt;/code> èƒ½æ¸…æ¥šçš„å¾—çŸ¥ &lt;code>type T = Int&lt;/code>ï¼Œå› æ­¤ &lt;code>max&amp;lt;T&amp;gt;&lt;/code> ä¼šè¢«æ‹·è´å¹¶è¢«ç‰¹ä¾‹åŒ–æˆ &lt;code>max&amp;lt;Int&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code>func max&amp;lt;Int&amp;gt;(x: Int, y: Int) -&amp;gt; Int {
return y &amp;lt; x ? x : y
}
&lt;/code>&lt;/pre>
&lt;p>ç„¶è€Œé—®é¢˜æ˜¯åœ¨å¦‚ä¸‹çš„æƒ…å†µä¹Ÿæ˜¯å¤§éƒ¨åˆ†å·¥ç¨‹ä¸­æœ€å¸¸è§çš„æƒ…å†µä¸‹ï¼Œå¯¹äº File1.swift æ¥è¯´ File2.Swift åœ¨ç¼–è¯‘æœŸæ˜¯ä¸å¯è§çš„ï¼Œ&lt;code>Generic Specialization&lt;/code> ä¹Ÿå› æ­¤å¤±å»äº†ä½œç”¨ã€‚&lt;/p>
&lt;pre>&lt;code>// Module Foo
// File1.swift
@_inlineable
public func max&amp;lt;T : Comparable&amp;gt;(_ x: T, _ y: T) -&amp;gt; T {
// In case `x == y`, we pick `y`. See min(_:_:).
return y &amp;gt;= x ? y : x
}
// File2.swift
func bar() {
let x: Int = ...
let y: Int = ...
let ret = max(x, y)
...
}
&lt;/code>&lt;/pre>
&lt;blockquote>
&lt;p>It&amp;rsquo;s not &lt;strong>good&lt;/strong> ğŸ™.&lt;/p>
&lt;/blockquote>
&lt;p>å°±æ—¶å€™å°±èƒ½ä½“ç°å‡º &lt;code>WMO&lt;/code> çš„ä¼˜åŠ¿ï¼Œé¢—ç²’åº¦ä¸Šå‡è‡³æ¨¡å—ä¹‹åï¼ŒFile1ï¼ŒFile2 ä¼šè¢«åˆå¹¶ï¼Œæ‰€æœ‰ Source å¤„äºåŒä¸€ä¸Šä¸‹æ–‡ï¼Œå› æ­¤ç¼–è¯‘å™¨æœ‰è¶³å¤Ÿçš„ä¿¡æ¯å»ä¼˜åŒ–ç”Ÿæˆæˆå¦‚ä¸‹ high &lt;strong>perfromace&lt;/strong> çš„ä»£ç ã€‚&lt;/p>
&lt;pre>&lt;code>// Module Foo
// Foo-Merged.swift
@_inlineable
public func max&amp;lt;Int&amp;gt;(_ x: Int, _ y: Int) -&amp;gt; Int {
return y &amp;gt;= x ? y : x
}
func bar() {
let x: Int = ...
let y: Int = ...
let ret = max&amp;lt;T&amp;gt;(x, y)
...
}
&lt;/code>&lt;/pre>
&lt;h3 id="dynamic-dispatch">Dynamic Dispatch&lt;/h3>
&lt;p>å‡è®¾æœ‰ä¸€ä¸ª &lt;code>class Car&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code>// Module A
// File1.Swift
class Car {
// should not override
var brand: String
func turboCharge()
// turboCharge implementation, called by turboCharge(), should not override
func turboChargeImpl()
}
// File1.swift
class Porsche: Car {
var model: String
override func turboCharge()
// å¯¹äºå­ç±»ï¼Œä»»ä½•ç»§æ‰¿äºçˆ¶ç±»çš„é private funcã€property éƒ½æ˜¯ä»¥ Dynamic Dispatch
// çš„å½¢å¼è°ƒç”¨çš„ï¼Œå³ä½¿æ²¡æœ‰è¢« override
// assumed to be overridden by compiler
// func turboChargeImpl()
}
&lt;/code>&lt;/pre>
&lt;p>ç„¶åæˆ‘ä»¬æœ‰ä¸ª &lt;code>class Driver&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code>// File2.swift
class Driver {
var name: String
func turbo(of car: Car) {
print(&amp;quot;Strat turbo of \(car.brand)&amp;quot;)
car.turboCharge()
}
}
&lt;/code>&lt;/pre>
&lt;p>é‚£ä¹ˆå¯¹äº &lt;code>Driver.turbo&lt;/code> ç¼–è¯‘å™¨ä¼šç”Ÿæˆå¦‚ä¸‹ä¼ªä»£ç ã€‚&lt;/p>
&lt;pre>&lt;code>class Driver {
Â·Â·Â·
func turbo(a car: Car) {
let brandGetter = Car.brandGetter(car)
print(&amp;quot;Strat turbo of \(brandGetter(car))&amp;quot;)
let turboCharge = Car.turboCharge(car)
turboCharge(car)
}
Â·Â·Â·
}
&lt;/code>&lt;/pre>
&lt;p>ç”±äºå±€é™äºå•æ–‡ä»¶ &lt;code>Scope&lt;/code>ï¼Œç¼–è¯‘å™¨æ— ä»å¾—çŸ¥æ‰€ç»™åˆ°ç±»çš„å±‚çº§ä¿¡æ¯ï¼Œè‡ªç„¶æ— æ³•å¾—çŸ¥æœ‰å“ªäº› &lt;code>property&lt;/code>ï¼Œ&lt;code>func&lt;/code> æ˜¯è¢« &lt;code>override&lt;/code>çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¿…é¡»æ’å…¥é—´æ¥è¿ç®—ä»¥å®Œæˆ &lt;code>Dynamic Dispatch&lt;/code>ã€‚å¯¹äºä¸ä¼šè¢« &lt;code>override&lt;/code> çš„ &lt;code>Car.brand&lt;/code>ã€&lt;code>Car.turboChargeImpl&lt;/code>ï¼Œå¯ä»¥é€šè¿‡ &lt;code>final&lt;/code> é™åˆ¶å­ç±»çš„ &lt;code>override&lt;/code> æˆ–è€…é€šè¿‡ &lt;code>private&lt;/code> é™åˆ¶å­ç±»çš„ &lt;code>Access Control&lt;/code> æ¥è¾¾åˆ° &lt;code>Static Dispatch&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code>class Car {
Â·Â·Â·
final var brand: String
private func turboChargeImpl()
}
&lt;/code>&lt;/pre>
&lt;p>äºæ˜¯ç¼–è¯‘å™¨å°±ä¼šç”Ÿæˆå¦‚ä¸‹ä¼ªä»£ç ã€‚&lt;/p>
&lt;pre>&lt;code>class Driver {
Â·Â·Â·
func turbo(a car: Car) {
print(&amp;quot;Strat turbo of \(car.brand)&amp;quot;)
let turboCharge = Car.turboCharge(car)
turboCharge(car)
}
Â·Â·Â·
}
&lt;/code>&lt;/pre>
&lt;p>å›åˆ° &lt;code>WMO&lt;/code>ï¼Œåœ¨ä¸Šæ–‡åŸºç¡€ä¸Šï¼Œå‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªæƒ…æ™¯ã€‚&lt;/p>
&lt;pre>&lt;code>// Module A
// File2.swift
class Driver {
Â·Â·Â·
func turbo(a porsche: Porsche) {
porsche.turbo()
}
Â·Â·Â·
}
&lt;/code>&lt;/pre>
&lt;p>è¿™æ ·ä¸€æ®µä»£ç ä¼šè¢«æ”¹å†™æˆå¦‚ä¸‹ã€‚&lt;/p>
&lt;pre>&lt;code>class Driver {
Â·Â·Â·
func turbo(a porsche: Porsche) {
let turboCharge = Porsche.turboCharge(porsche)
turboCharge(car)
}
Â·Â·Â·
}
&lt;/code>&lt;/pre>
&lt;p>åœ¨ &lt;code>class Prosche&lt;/code> æ²¡æœ‰ä»»ä½• &lt;code>subclass&lt;/code> çš„æƒ…å†µä¸‹ï¼Œ&lt;code>Dynamic Dispatch&lt;/code> å®é™…ä¸Šæ˜¯æ¯«æ— æ„ä¹‰çš„ï¼Œå› æ­¤ &lt;code>WMO&lt;/code> åˆä¸€æ¬¡å‘æŒ¥äº†ä½œç”¨ï¼ŒæŠŠ Visibility æå‡åˆ°æ•´ä¸ªæ¨¡å—ä¹‹å Compiler èƒ½ç†è§£ &lt;code>Prosche&lt;/code> çš„ç±»å±‚çº§ã€å¹¶ä¸” &lt;code>Prosche&lt;/code> æ²¡æœ‰å­ç±»ï¼Œå› æ­¤ &lt;code>func turbo(a porsche: Porsche)&lt;/code> æ˜¯å®Œå…¨ Static çš„ï¼Œæ‰€ä»¥ä»£ç æœ€ç»ˆä¼šè¢«æ”¹å†™æˆå¦‚ä¸‹ã€‚&lt;/p>
&lt;pre>&lt;code>// Module A
// A-Merged.Swift
class Car {
final var brand: String
func turboCharge()
private func turboChargeImpl()
}
class Porsche: Car {
final var model: String
override func turboCharge()
}
class Driver {
func turbo(a car: Car) {
print(&amp;quot;Strat turbo of \(car.brand)&amp;quot;)
let turboCharge = Car.turboCharge(car)
turboCharge(car)
}
func turbo(a porsche: Porsche) {
porsche.turbo()
}
}
&lt;/code>&lt;/pre>
&lt;p>ç›¸æ¯”äº objc çš„ä¸€åˆ‡çš†åŠ¨æ€ï¼ŒSwift åœ¨ç¼–è¯‘å™¨èƒ½è·å¾—ä¸°å¯Œçš„ä¿¡æ¯å»é¿å… &lt;code>Dynamic Dispatch&lt;/code> è¿™ä¹Ÿä¸ºä»€ä¹ˆ Swift åœ¨ Object-Oriented Benchmark ä¸Šèƒ½ç§’æ€ objcï¼Œå¯è§ä¸€ä¸ªè®¾è®¡ä¼˜è‰¯çš„ &lt;code>class&lt;/code> ä¸ä»…åœ¨å·¥ç¨‹æ˜“ç»´æŠ¤æ€§ä¸Šå¸¦æ¥è®¸å¤šæ–¹ä¾¿ï¼ŒåŒæ—¶åœ¨æ€§èƒ½ä¸Šä¹Ÿèƒ½è·å¾—å·¨å¤§çš„æ”¶ç›Šã€‚&lt;/p>
&lt;h2 id="wmo-çš„é€‚ç”¨èŒƒå›´">&lt;code>WMO&lt;/code> çš„é€‚ç”¨èŒƒå›´&lt;/h2>
&lt;p>ä½†å°±å¦‚ä¸Šæ–‡æ‰€è¯´çš„ï¼Œ&lt;code>WMO&lt;/code> ä¸‹å¢é‡ç¼–è¯‘é¢—ç²’åº¦ä¸Šå‡è‡³æ•´ä¸ªæ¨¡å—ï¼Œæ„å‘³ç€ä¸ç®¡ä¿®æ”¹å“ªä¸ªæ–‡ä»¶ï¼Œä¸‹ä¸€æ¬¡ build æ€»æ˜¯ Whole-Module buildï¼Œå¤§å¤§å¢åŠ äº† build timeï¼Œè™½ç„¶ &lt;code>WMO&lt;/code> å¸¦æ¥çš„ clean build æ—¶é—´ç¼©çŸ­æ˜¯å¯è§‚çš„ï¼Œä½†å’Œ &lt;code>-Onone&lt;/code>ã€&lt;code>SFO&lt;/code> ä¸‹çš„å¢é‡ç¼–è¯‘ç›¸æ¯”å¹¶ä¸åœ¨ä¸€ä¸ªé‡çº§ï¼Œæ‰€ä»¥è¿™å¯¹äºæ—¥å¸¸çš„å¼€å‘æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå› æ­¤ &lt;code>WMO&lt;/code> ä½œä¸ºæ ‡é…æ¥è¯´ä¹Ÿä»…ä»…æ˜¯åœ¨ release build çš„æƒ…å†µä¸‹ï¼Œå®ƒå¹¶ä¸æ˜¯æ— æ•Œçš„ã€‚&lt;/p>
&lt;p>&lt;img src="./wmo.png" alt="wmo">&lt;/p>
&lt;p>åŒæ—¶åœ¨å¼€å¯äº†ä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œ&lt;code>LLDB&lt;/code> ä¹Ÿä¼šè¡¨ç°çš„ä¸æ­£å¸¸&lt;/p>
&lt;pre>&lt;code>MyApp was compiled with optimization - stepping may behave oddly; variables may not be available.
&lt;/code>&lt;/pre>
&lt;p>æ‰€ä»¥ï¼Œå¦‚æœæœ‰æ— æ³•é¿å…çš„ç†ç”±éœ€è¦åœ¨ &lt;strong>Debug&lt;/strong> æƒ…å†µä¸‹è¦ç”¨åˆ° &lt;code>WMO&lt;/code>ï¼Œé‚£ä¹ˆ&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Debug&lt;/strong> ä¸‹æ‰“å¼€ &lt;code>WMO&lt;/code>ï¼Œ&lt;code>Other Swift Flags&lt;/code> é‡Œæ·»åŠ  &lt;code>-Onone&lt;/code>&lt;/li>
&lt;li>&lt;strong>Debug&lt;/strong> ä¸‹å…³é—­ &lt;code>WMO&lt;/code>ï¼Œ&lt;code>User-Defined&lt;/code> é‡Œæ·»åŠ  &lt;code>SWIFT_WHOLE_MODULE_OPTIMIZATION&lt;/code> = &lt;code>YES&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸Šä¸¤ç§æ–¹å¼éƒ½å¯ä»¥æŠŠæ‰€æœ‰æ–‡ä»¶åˆå¹¶ï¼Œä¸”ä¸åšä»»ä½•ç¼–è¯‘ä¼˜åŒ–ï¼Œå‡å°‘äº† Context çš„åˆ†æï¼Œä¸ä½†èƒ½å¤Ÿ Debugï¼Œè€Œä¸”ç›¸æ¯”äº &lt;code>Whole-Module Optimization&lt;/code> è¿˜å¯ä»¥è¾¾åˆ°æ›´å¿«çš„ç¼–è¯‘é€Ÿåº¦ã€‚å¯¹äº CocoaPods å¼•å…¥çš„ Swift frameworkï¼Œå¯ä»¥åœ¨ hook é‡Œä¸ºæ¯ä¸ª target åšé…ç½®ã€‚&lt;/p>
&lt;pre>&lt;code class="language-ruby">post_install do |installer|
installer.pods_project.targets.each do |target|
target.build_configurations.each do |config|
if config.name == 'Debug'
config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Owholemodule'
config.build_settings['OTHER_SWIFT_FLAGS'] = '-Onone $(inherited)'
end
end
end
end
&lt;/code>&lt;/pre>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>&lt;code>WMO&lt;/code> çš„æƒ…å†µä¸‹ï¼Œé…åˆè‰¯å¥½çš„ä»£ç è®¾è®¡ä¼šç»™äºˆæ•´ä¸ªå·¥ç¨‹å¸¦æ¥ä¸å®¹å¿½è§†çš„æ”¶ç›Šï¼Œç”¨ Apple çš„è¯æ¥è¯´å°±æ˜¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>All I need to do is to turn on Whole-Module Optimization. I don&amp;rsquo;t need to change code at all. By giving the compiler more information, by allowing the compiler to understand my class hierachy with more information, I was able to get this optimization for &lt;strong>free&lt;/strong> without any work on your part.&lt;/p>
&lt;/blockquote>
&lt;h2 id="è¿›ä¸€æ­¥äº†è§£">è¿›ä¸€æ­¥äº†è§£&lt;/h2>
&lt;ol start="0">
&lt;li>&lt;a href="https://swift.org/blog/whole-module-optimizations/" target="_blank" rel="noopener">Whole-Module Optimization in Swift 3&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.apple.com/videos/play/wwdc2015/409/" target="_blank" rel="noopener">Optimizing Swift Performance&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://developear.com/blog/2016/12/30/Speed-Swift-Compilation.html" target="_blank" rel="noopener">Speeding Up Compile Times of Swift Projects&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.skilled.io/u/swiftsummit/swift-with-a-hundred-engineers" target="_blank" rel="noopener">Swift with a hundred engineers&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://nondot.org/sabre/" target="_blank" rel="noopener">Chris Lattner&amp;rsquo;s Homepage&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Clang Attributes ä½¿ç”¨æ–‡æ¡£</title><link>/2015/11/28/clang-attributes-%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/</link><pubDate>Sat, 28 Nov 2015 15:44:16 +0000</pubDate><guid>/2015/11/28/clang-attributes-%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/</guid><description>&lt;div class="alert alert-note">
&lt;div>
Continually Updated
&lt;/div>
&lt;/div>
&lt;p>&lt;code>__attribute__&lt;/code> æœ€åˆä½œä¸º GNU C çš„ç‰¹æ€§ï¼Œä¸º C/C++ã€Objective-C/C++ æä¾›äº†ç¼–è¯‘å™¨çº§åˆ«çš„æ ‡æ³¨ï¼Œç”¨æ¥ä¿®é¥°ä¸€ä¸ªå˜é‡ã€å‡½æ•°æˆ–ç±»å‹ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹ç‰¹æ€§ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html" target="_blank" rel="noopener">Function Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Variable-Attributes.html" target="_blank" rel="noopener">Variable Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Type-Attributes.html" target="_blank" rel="noopener">Type Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Label-Attributes.html" target="_blank" rel="noopener">Label Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Enumerator-Attributes.html" target="_blank" rel="noopener">Enumerator Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Statement-Attributes.html" target="_blank" rel="noopener">Statement Attributes&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>åŒæ · Clang ä¹Ÿå¾ˆå¥½çš„å…¼å®¹äº† GGC è¿™ä¸€ç‰¹æ€§ï¼Œå¹¶åšäº†é¢å¤–çš„æ‰©å±•ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a href="http://clang.llvm.org/docs/AttributeReference.html#calling-conventions" target="_blank" rel="noopener">Calling Conventions&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://clang.llvm.org/docs/AttributeReference.html#nullability-attributes" target="_blank" rel="noopener">Nullability Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://clang.llvm.org/docs/AttributeReference.html#amd-gpu-attributes" target="_blank" rel="noopener">AMD GPU Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://clang.llvm.org/docs/AttributeReference.html#consumed-annotation-checking" target="_blank" rel="noopener">Consumed Annotation Checking&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://clang.llvm.org/docs/AttributeReference.html#type-safety-checking" target="_blank" rel="noopener">Type Safety Checking&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://clang.llvm.org/docs/AttributeReference.html#opencl-address-spaces" target="_blank" rel="noopener">OpenCL Address Spaces&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://clang.llvm.org/docs/AttributeReference.html#customizing-swift-import" target="_blank" rel="noopener">Customizing Swift Import&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>è¯¸å¦‚ä¼˜åŒ–ã€é”™è¯¯æ£€æŸ¥ä¹‹ç±»çš„æœºæ¢°åŒ–ä»»åŠ¡ç†åº”ç”±ç¼–è¯‘å™¨å»å®Œæˆï¼Œä½†å¸¸è¨€é“â€œå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨â€åªæœ‰è®©ç¼–è¯‘å™¨æ›´åŠ æ‡‚ä½ ï¼Œæ‰èƒ½æŠŠç¼–è¯‘å™¨çš„æ€§èƒ½ã€ä¼˜åŒ–å‘æŒ¥åˆ°æè‡´ã€‚&lt;/p>
&lt;details class="toc-inpage d-print-none " open>
&lt;summary class="font-weight-bold">ç›®å½•&lt;/summary>
&lt;nav id="TableOfContents">
&lt;ul>
&lt;li>&lt;a href="#variable-attributes">Variable Attributes&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#noescape">&lt;code>noescape&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="#section-__declspecallocate">&lt;code>section, __declspec(allocate)&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="#used">&lt;code>used&lt;/code>&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#type-attributes">Type Attributes&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#objc_root_class">&lt;code>objc_root_class&lt;/code>&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#function-attributes">Function Attributes&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#overloadable">&lt;code>overloadable&lt;/code>&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#customizing-swift-import">Customizing Swift Import&lt;/a>
&lt;ul>
&lt;li>&lt;a href="#swift_bridge">&lt;code>swift_bridge&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="#swift_bridged">&lt;code>swift_bridged&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="#swift_name">&lt;code>swift_name&lt;/code>&lt;/a>&lt;/li>
&lt;li>&lt;a href="#swift_newtype">&lt;code>swift_newtype&lt;/code>&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;a href="#è¿›ä¸€æ­¥äº†è§£">è¿›ä¸€æ­¥äº†è§£&lt;/a>&lt;/li>
&lt;/ul>
&lt;/nav>
&lt;/details>
&lt;h2 id="variable-attributes">Variable Attributes&lt;/h2>
&lt;h3 id="noescape">&lt;code>noescape&lt;/code>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>GNU&lt;/th>
&lt;th>C++11&lt;/th>
&lt;th>C2x&lt;/th>
&lt;th>__declspec&lt;/th>
&lt;th>Keyword&lt;/th>
&lt;th>Pragma&lt;/th>
&lt;th>Pragma clang attribute&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>noescape&lt;/code>&lt;/td>
&lt;td>&lt;code>clang::noescape&lt;/code>&lt;/td>
&lt;td>&lt;code>clang::noescape&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="section-__declspecallocate">&lt;code>section, __declspec(allocate)&lt;/code>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>GNU&lt;/th>
&lt;th>C++11&lt;/th>
&lt;th>C2x&lt;/th>
&lt;th>__declspec&lt;/th>
&lt;th>Keyword&lt;/th>
&lt;th>Pragma&lt;/th>
&lt;th>Pragma clang attribute&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>section&lt;/code>&lt;/td>
&lt;td>&lt;code>gnu::section&lt;/code>&lt;/td>
&lt;td>&lt;code>gnu::section&lt;/code>&lt;/td>
&lt;td>&lt;code>allocate&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;code>section&lt;/code> ç‰¹æ€§ä½¿å¾—æˆ‘ä»¬èƒ½å°†æŒ‡å®šçš„å˜é‡æˆ–è€…å‡½æ•°æ’å…¥åˆ°æŒ‡å®š section ä¸­ï¼Œæ¯”å¦‚æŠŠä¸€ä¸ªå­—ç¬¦ä¸²ç›´æ¥å¡å…¥æ•°æ®æ®µã€‚&lt;/p>
&lt;pre>&lt;code class="language-c">char *string __attribute((section(&amp;quot;__DATA, Custom&amp;quot;))) = &amp;quot;I'm a pure string.&amp;quot;
&lt;/code>&lt;/pre>
&lt;h3 id="used">&lt;code>used&lt;/code>&lt;/h3>
&lt;p>&lt;code>__attribute((used))&lt;/code> ç”¨æ¥ä¿®é¥°å˜é‡æˆ–è€…å‡½æ•°ã€‚é€šå¸¸é»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰è¢«å¼•ç”¨çš„ç¬¦å·ä¼šè¢«é“¾æ¥å™¨ä¼˜åŒ–å»é™¤ã€‚æ ‡æ³¨ &lt;code>used&lt;/code> ä¹‹åæ„å‘³ç€å³ä½¿ç¬¦å·æ²¡æœ‰è¢«å¼•ç”¨ï¼Œä¹Ÿä¸ä¼šè¢«è¿æ¥å™¨ä¼˜åŒ–æ‰ã€‚&lt;/p>
&lt;h2 id="type-attributes">Type Attributes&lt;/h2>
&lt;h3 id="objc_root_class">&lt;code>objc_root_class&lt;/code>&lt;/h3>
&lt;p>åœ¨ &lt;code>Foundation&lt;/code> ä¸­å¯¹åº” &lt;code>OBJC_ROOT_CLASS&lt;/code>ï¼Œ&lt;code>__attribute__((objc_root_class))&lt;/code> ç”¨äºç”³æ˜ä¸€ä¸ªæ²¡æœ‰æ ¹ç±»çš„ objc classï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å®ç°ç±»ä¼¼ &lt;code>name space&lt;/code> çš„æ•ˆæœï¼Œä½¿å¾— ObjC å˜å¾—æ›´ Swiftã€‚&lt;/p>
&lt;pre>&lt;code class="language-objc">__attribute__((objc_root_class)) @interface NotificationName
@property (class, readonly) NSNotificationName NSApplicationDidFinishLaunching;
@end
@implementation NotificationName
+ (NSNotificationName)NSApplicationDidFinishLaunching {
return NSApplicationDidFinishLaunchingNotification;
}
@end
&lt;/code>&lt;/pre>
&lt;h2 id="function-attributes">Function Attributes&lt;/h2>
&lt;h3 id="overloadable">&lt;code>overloadable&lt;/code>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>GNU&lt;/th>
&lt;th>C++11&lt;/th>
&lt;th>C2x&lt;/th>
&lt;th>__declspec&lt;/th>
&lt;th>Keyword&lt;/th>
&lt;th>Pragma&lt;/th>
&lt;th>Pragma clang attribute&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>overloadable&lt;/code>&lt;/td>
&lt;td>&lt;code>clang::overloadable&lt;/code>&lt;/td>
&lt;td>&lt;code>clang::overloadable&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Clang ä¸º C å¼•å…¥äº†å’Œ C++ ä¸€æ ·çš„ &lt;code>name mangling&lt;/code>ï¼Œä½¿ç”¨ &lt;code>overloadable&lt;/code> å¯¹ C å‡½æ•°è¿›è¡Œ &lt;code>overload&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code class="language-c">#include &amp;lt;math.h&amp;gt;
float __attribute__((overloadable)) tgsin(float x) {
return sinf(x);
}
double __attribute__((overloadable)) tgsin(double x) {
return sin(x);
}
long double __attribute__((overloadable)) tgsin(long double x) {
return sinl(x);
}
&lt;/code>&lt;/pre>
&lt;p>ä¼šå¾—åˆ°ç±»ä¼¼äº &lt;code>_Z5tgsinf&lt;/code>ã€&lt;code>_Z5tgsind&lt;/code>ã€&lt;code>_Z5tgsine&lt;/code> è¿™ä¸‰ä¸ªç¬¦å·ï¼ŒåŒæ ·å¯¹äº ObjC Typeã€‚&lt;/p>
&lt;pre>&lt;code class="language-objc">#import &amp;lt;Foundation/Foundation.h&amp;gt;
void __attribute__((overloadable)) detectTypeof(NSInteger i) {
fprintf(stdout, &amp;quot;%s\n&amp;quot;, @encode(typeof(i)));
}
void __attribute__((overloadable)) detectTypeof(CGFloat f) {
fprintf(stdout, &amp;quot;%s\n&amp;quot;, @encode(typeof(f)));
}
void __attribute__((overloadable)) detectTypeof(NSString *string) {
fprintf(stdout, &amp;quot;%s: NSString\n&amp;quot;, @encode(typeof(string)));
}
void __attribute__((overloadable)) detectTypeof(NSArray *array) {
fprintf(stdout, &amp;quot;%s: NSArray\n&amp;quot;, @encode(typeof(array)));
}
void __attribute__((overloadable)) detectTypeof(NSObject *object) {
fprintf(stdout, &amp;quot;%s: NSObject\n&amp;quot;, @encode(typeof(object)));
}
int main(int argc, const char * argv[]) {
detectTypeof((NSInteger)1);
detectTypeof(1.0);
detectTypeof(@&amp;quot;Hello&amp;quot;);
detectTypeof(@[@(1)]);
detectTypeof(NSObject.new);
return 0;
}
&lt;/code>&lt;/pre>
&lt;p>è¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚&lt;/p>
&lt;pre>&lt;code class="language-bash">q
d
@: NSString
@: NSArray
@: NSObject
&lt;/code>&lt;/pre>
&lt;h2 id="customizing-swift-import">Customizing Swift Import&lt;/h2>
&lt;h3 id="swift_bridge">&lt;code>swift_bridge&lt;/code>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>GNU&lt;/th>
&lt;th>C++11&lt;/th>
&lt;th>C2x&lt;/th>
&lt;th>__declspec&lt;/th>
&lt;th>Keyword&lt;/th>
&lt;th>Pragma&lt;/th>
&lt;th>Pragma clang attribute&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>swift_bridge&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;code>swift_bridge&lt;/code> ç”¨äºå°† ObjC çš„å£°æ˜å’Œ Swift ç±»å‹è¿›è¡Œ Bridgeï¼Œä¸º Swift Interoperability çš„ä½“ç°ï¼Œæ›´å¤šå¯ä»¥å‚è€ƒ &lt;a href="https://developer.apple.com/videos/play/wwdc2015/401/" target="_blank" rel="noopener">WWDC&lt;/a>ã€‚Swift æ ‡å‡†åº“ä¸­çš„ç›¸å½“ä¸€éƒ¨åˆ†ç±»å‹éƒ½æœ‰ Interoperability ç‰¹æ€§ï¼Œä¸ Cocoa æœ‰ä¸€å±‚éšå¼ bridgeï¼Œæ¯”å¦‚ &lt;code>NSArray&lt;/code>ã€&lt;code>NSMutableArray&lt;/code> å’Œ &lt;code>Swift.Array&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸‹æ–¹ä¾‹å­ä¸­ï¼ŒObjC ç±» &lt;code>DerivatedObjCClass&lt;/code> è¢« bridge åˆ° Swift ä¸­çš„ &lt;code>DerivatedClass&lt;/code>ã€‚&lt;/p>
&lt;pre>&lt;code>__attribute__((objc_root_class))
@interface BaseClass
- (instancetype)init;
@end
__attribute__((__swift_bridge__(&amp;quot;DerivatedClass&amp;quot;)))
@interface DerivatedObjCClass: BaseClass
@end
&lt;/code>&lt;/pre>
&lt;p>æ›´å¤šç›¸å…³å†…å®¹å¯ä»¥å‚è€ƒ LLVM çš„ Phab Review D87532 &lt;a href="https://reviews.llvm.org/D87532" target="_blank" rel="noopener">Sema: add support for &lt;code>__attribute__((__swift_bridge__))&lt;/code>&lt;/a> ä»¥åŠ swift çš„ &lt;a href="https://github.com/apple/swift/blob/41d5e57b5586fccd4ba3823e8ac4690b7b30ec59/lib/ClangImporter/ImportType.cpp#L944" target="_blank" rel="noopener">ClangImporter&lt;/a>ã€‚&lt;/p>
&lt;h3 id="swift_bridged">&lt;code>swift_bridged&lt;/code>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>GNU&lt;/th>
&lt;th>C++11&lt;/th>
&lt;th>C2x&lt;/th>
&lt;th>__declspec&lt;/th>
&lt;th>Keyword&lt;/th>
&lt;th>Pragma&lt;/th>
&lt;th>Pragma clang attribute&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>swift_bridged&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>åœ¨ CoreFoundation ä¸­å¯¹åº” &lt;code>CF_SWIFT_BRIDGED_TYPEDEF&lt;/code>ï¼Œé…åˆ &lt;code>swift_bridge&lt;/code> ä½¿ç”¨ï¼Œç”¨äºè¢« &lt;code>swift_bridge&lt;/code> æè¿°çš„ç±»å‹çš„ &lt;code>typedef&lt;/code> ç±»å‹ã€‚ä»¥ &lt;code>NSString&lt;/code> -&amp;gt; &lt;code>Swift.String&lt;/code> ä¸ºä¾‹ï¼Œåœ¨ ObjC ä¸­æœ‰å¦‚ä¸‹å£°æ˜ï¼š&lt;/p>
&lt;pre>&lt;code class="language-objc">@interface NSString;
typedef NSString *AliasedString __attribute__((__swift_bridged_typedef__));
extern void foo(AliasedString _Nonnull str);
&lt;/code>&lt;/pre>
&lt;p>åœ¨ Swift ä¸­ä¼šè¢« Bridge ä¸ºï¼š&lt;/p>
&lt;pre>&lt;code class="language-swift">func foo(_ str: String) -&amp;gt; Void
&lt;/code>&lt;/pre>
&lt;p>è¿™ä¸ªæ“ä½œåŒæ ·ä¼šç”± Swift Compiler ç›´æ¥å®Œæˆï¼Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨å£°æ˜ã€‚&lt;/p>
&lt;h3 id="swift_name">&lt;code>swift_name&lt;/code>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>GNU&lt;/th>
&lt;th>C++11&lt;/th>
&lt;th>C2x&lt;/th>
&lt;th>__declspec&lt;/th>
&lt;th>Keyword&lt;/th>
&lt;th>Pragma&lt;/th>
&lt;th>Pragma clang attribute&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>swift_name&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>åœ¨ CoreFoundation ä¸­å¯¹åº” &lt;code>CF_SWIFT_NAME&lt;/code>ï¼Œ&lt;code>swift_name&lt;/code> ä¸º C/ObjC çš„å£°æ˜æä¾›äº†åœ¨ Swift ä¸­ç¬¦å·åï¼Œé»˜è®¤æƒ…å†µä¼šæ ¹æ® Swift Compiler çš„ç®—æ³•è§„åˆ™è‡ªåŠ¨ç”Ÿæˆã€‚&lt;/p>
&lt;pre>&lt;code>@interface NSData
- (instancetype)initWithData:(NSData *)data __attribute__((__swift_name__(&amp;quot;Data.init(_:)&amp;quot;)));
@end
void __attribute__((__swift_name__(&amp;quot;squareRoot()&amp;quot;))) sqrtf(float f);
&lt;/code>&lt;/pre>
&lt;h3 id="swift_newtype">&lt;code>swift_newtype&lt;/code>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>GNU&lt;/th>
&lt;th>C++11&lt;/th>
&lt;th>C2x&lt;/th>
&lt;th>__declspec&lt;/th>
&lt;th>Keyword&lt;/th>
&lt;th>Pragma&lt;/th>
&lt;th>Pragma clang attribute&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>swift_newtype&lt;/code> &lt;code>swift_wrapper&lt;/code>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>åœ¨ CoreFoundation ä¸­å¯¹åº” &lt;code>_CF_TYPED_EXTENSIBLE_ENUM&lt;/code>ã€‚&lt;/p>
&lt;h2 id="è¿›ä¸€æ­¥äº†è§£">è¿›ä¸€æ­¥äº†è§£&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="http://clang.llvm.org/docs/AttributeReference.html" target="_blank" rel="noopener">Attributes in Clang&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Attribute-Syntax.html" target="_blank" rel="noopener">Attribute Syntax&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://gcc.gnu.org/onlinedocs/gcc/Enumerator-Attributes.html" target="_blank" rel="noopener">Enumerator Attributes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.keil.com/support/man/docs/armcc/armcc_chr1359124965789.htm" target="_blank" rel="noopener">Compiler-specific Features&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://nshipster.com/__attribute__" target="_blank" rel="noopener">NSHipster __ attribute __&lt;/a>&lt;/li>
&lt;/ol></description></item></channel></rss>